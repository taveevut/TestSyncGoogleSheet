<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-400 to-purple-500 p-6">
  <div class="mx-auto max-w-6xl bg-white/95 rounded-2xl shadow-2xl overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-8 text-center">
      <h1 class="text-3xl font-bold drop-shadow">üìö ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <p class="opacity-90 mt-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
    </div>

    <div class="p-6 md:p-8 space-y-6">
      <!-- Google Sheets info -->
      <div id="gsBox"
           class="rounded-xl p-5 text-white text-center bg-gradient-to-r from-blue-500 to-green-500">
        <h3 class="text-xl font-semibold">üîó ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets</h3>
        <p class="mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô Google Sheets ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô Google Drive</p>
        <button onclick="connectGoogleSheets()"
                class="mt-3 inline-flex items-center gap-2 px-5 py-2 rounded-lg bg-black/20 hover:bg-black/30 transition">
          ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
        </button>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="rounded-xl p-5 text-white bg-gradient-to-r from-indigo-500 to-purple-500 shadow">
          <div id="totalIncidents"
               class="text-3xl font-bold">0</div>
          <div class="opacity-90">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
        <div class="rounded-xl p-5 text-white bg-gradient-to-r from-rose-500 to-pink-500 shadow">
          <div id="highSeverityCount"
               class="text-3xl font-bold">0</div>
          <div class="opacity-90">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏™‡∏π‡∏á</div>
        </div>
        <div class="rounded-xl p-5 text-white bg-gradient-to-r from-amber-500 to-yellow-400 shadow">
          <div id="mediumSeverityCount"
               class="text-3xl font-bold">0</div>
          <div class="opacity-90">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á</div>
        </div>
        <div class="rounded-xl p-5 text-white bg-gradient-to-r from-emerald-500 to-lime-500 shadow">
          <div id="lowSeverityCount"
               class="text-3xl font-bold">0</div>
          <div class="opacity-90">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≥</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap items-center gap-3">
        <button class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold"
                onclick="openModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        <button class="px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-semibold"
                onclick="exportToExcel()">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</button>
        <button class="px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-white font-semibold"
                onclick="importFromExcel()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</button>
        <input id="searchInput"
               type="text"
               placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
               onkeyup="searchRecords()"
               class="flex-1 min-w-[220px] px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0" />
        <input id="excelImport"
               type="file"
               accept=".xlsx,.xls"
               class="hidden"
               onchange="handleExcelImport(event)">
        <button id="printBtn"
                class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-800 text-white font-semibold"
                onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto bg-white rounded-xl shadow">
        <table class="w-full text-left">
          <thead class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
            <tr>
              <th class="py-3 px-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="py-3 px-4">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th class="py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
              <th class="py-3 px-4">‡∏ä‡∏±‡πâ‡∏ô</th>
              <th class="py-3 px-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î</th>
              <th class="py-3 px-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              <th class="py-3 px-4">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</th>
              <th class="py-3 px-4">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
              <th class="py-3 px-4">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
              <th class="py-3 px-4">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="recordsTable"
                 class="divide-y"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="recordModal"
       class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-xl p-6 relative">
      <button class="absolute top-3 right-3 text-gray-400 hover:text-rose-500"
              onclick="closeModal()">‚úï</button>
      <h2 id="modalTitle"
          class="text-xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2>

      <form id="recordForm"
            class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <input id="studentId"
                   required
                   class="w-full mt-1 px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0" />
          </div>
          <div>
            <label class="font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="studentName"
                   required
                   class="w-full mt-1 px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0" />
          </div>
          <div>
            <label class="font-medium">‡∏ä‡∏±‡πâ‡∏ô</label>
            <input id="className"
                   required
                   class="w-full mt-1 px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0" />
          </div>
          <div>
            <label class="font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î</label>
            <select id="incidentType"
                    required
                    class="w-full mt-1 px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
              <option>‡∏°‡∏≤‡∏™‡∏≤‡∏¢</option>
              <option>‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</option>
              <option>‡πÑ‡∏°‡πà‡∏™‡∏ß‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ö‡∏ö</option>
              <option>‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó</option>
              <option>‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà</option>
              <option>‡∏û‡∏Å‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò</option>
              <option>‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</option>
              <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>
        </div>

        <div>
          <label class="font-medium">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <textarea id="description"
                    rows="3"
                    required
                    class="w-full mt-1 px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</label>
            <select id="severity"
                    required
                    class="w-full mt-1 px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</option>
              <option>‡∏ï‡πà‡∏≥</option>
              <option>‡∏Å‡∏•‡∏≤‡∏á</option>
              <option>‡∏™‡∏π‡∏á</option>
            </select>
          </div>
          <div>
            <label class="font-medium">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
            <input id="recorder"
                   required
                   class="w-full mt-1 px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-indigo-400 focus:ring-0" />
          </div>
        </div>

        <div>
          <label class="font-medium">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏£‡∏π‡∏õ)</label>
          <div class="mt-2 rounded-xl border-2 border-dashed border-indigo-300 p-4 text-center cursor-pointer hover:bg-indigo-50"
               onclick="document.getElementById('imageInput').click()">üì∑ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
          <input id="imageInput"
                 type="file"
                 accept="image/*"
                 multiple
                 class="hidden"
                 onchange="handleImageUpload(event)">
          <div id="uploadedImages"
               class="mt-3 flex flex-wrap gap-2"></div>
        </div>

        <div class="flex items-center gap-3 pt-2">
          <button type="submit"
                  class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button type="button"
                  class="px-4 py-2 rounded-lg bg-rose-500 hover:bg-rose-600 text-white font-semibold"
                  onclick="closeModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /** ===== CONFIG (‡πÅ‡∏Å‡πâ 2 ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ) ===== */
    const SPREADSHEET_ID = 'Sheet1';       // << Spreadsheet ID
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyaRR3dN_obgdXFG2so-aqH1ki2wnefXoxVDqXqnYDWBwnigVkZAEaLCd5a8kJCmisBXA/exec';
    /** ================================= */

    let records = [];
    let currentEditIndex = -1;
    let uploadedImages = []; // [{name, dataURL}] ‡∏´‡∏£‡∏∑‡∏≠ [{url}]
    let isGoogleSheetsConnected = false;

    const CACHE_KEY = 'student_incident_records_v1';

    // function saveRecordsToCache() {
    //   try {localStorage.setItem(CACHE_KEY, JSON.stringify(records));}
    //   catch (e) {console.warn('save cache error', e);}
    // }
    function saveRecordsToCache() {
      try {
        // clone ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏î base64 ‡∏ó‡∏¥‡πâ‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ url
        const slim = records.map(r => ({
          ...r,
          images: (r.images || [])
            .map(img => img.url ? {url: img.url, name: img.name || ''} : null)
            .filter(Boolean)
        }));
        localStorage.setItem(CACHE_KEY, JSON.stringify(slim));
      } catch (e) {
        console.warn('save cache error', e);
      }
    }

    function loadRecordsFromCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (Array.isArray(data)) {records = data; return true;}
      } catch (e) {console.warn('load cache error', e);}
      return false;
    }
    function commitAndRender() {
      saveRecordsToCache();
      updateStatistics();
      displayRecords();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // 1) ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å cache ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      const hadCache = loadRecordsFromCache();
      if (!hadCache) loadSampleData();
      commitAndRender();

      // 2) ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡∏°‡∏≤‡∏ó‡∏±‡∏ö
      await fetchFromGoogleSheets();
    });

    function loadSampleData() {
      records = [
        {date: '2025-01-15', studentId: 'ST001', studentName: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', className: '‡∏°.4/1', incidentType: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢', description: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢ 15 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏•‡∏≤', severity: '‡∏ï‡πà‡∏≥', images: [], recorder: '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á'},
        {date: '2025-01-14', studentId: 'ST002', studentName: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', className: '‡∏°.5/2', incidentType: '‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô', description: '‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', severity: '‡∏Å‡∏•‡∏≤‡∏á', images: [], recorder: '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ä‡∏±‡∏¢'}
      ];
    }

    // ===== Modal =====
    function openModal(index = -1) {
      currentEditIndex = index;
      document.getElementById('recordModal').classList.remove('hidden');
      document.getElementById('recordModal').classList.add('flex');
      document.getElementById('modalTitle').textContent = index >= 0 ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà';
      if (index >= 0) fillFormData(records[index]);
      else {document.getElementById('recordForm').reset(); uploadedImages = []; displayUploadedImages();}
    }
    function closeModal() {
      document.getElementById('recordModal').classList.add('hidden');
      document.getElementById('recordModal').classList.remove('flex');
      uploadedImages = [];
      displayUploadedImages();
    }
    function fillFormData(r) {
      studentId.value = r.studentId; studentName.value = r.studentName; className.value = r.className;
      incidentType.value = r.incidentType; description.value = r.description; severity.value = r.severity; recorder.value = r.recorder;
      uploadedImages = [...r.images];
      displayUploadedImages();
    }

    // ===== Form submit =====
    document.getElementById('recordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = { /* ...‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°... */};

      if (currentEditIndex >= 0) {
        records[currentEditIndex] = formData;
        alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
      } else {
        records.push(formData);
        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ã‡∏ü cache ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô base64)
      commitAndRender();

      if (isGoogleSheetsConnected) {
        // ‡∏™‡πà‡∏á index ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏±‡∏ö
        const idx = currentEditIndex >= 0 ? currentEditIndex : (records.length - 1);
        await syncToGoogleSheets(formData, idx);
        // ‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå URL ‡∏Ñ‡∏£‡∏ö
        await fetchFromGoogleSheets();
      }

      closeModal();
    });

    // document.getElementById('recordForm').addEventListener('submit', async (e) => {
    //   e.preventDefault();
    //   const formData = {
    //     date: new Date().toISOString().split('T')[0],
    //     studentId: studentId.value,
    //     studentName: studentName.value,
    //     className: className.value,
    //     incidentType: incidentType.value,
    //     description: description.value,
    //     severity: severity.value,
    //     images: [...uploadedImages], // base64 (‡∏´‡∏£‡∏∑‡∏≠ url ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    //     recorder: recorder.value
    //   };

    //   if (currentEditIndex >= 0) {records[currentEditIndex] = formData; alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');}
    //   else {records.push(formData); alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');}

    //   commitAndRender();

    //   if (isGoogleSheetsConnected) {
    //     await syncToGoogleSheets(formData);
    //     // ‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á (‡∏à‡∏≤‡∏Å Drive)
    //     await fetchFromGoogleSheets();
    //   }

    //   closeModal();
    // });

    // ===== Image upload =====
    function handleImageUpload(ev) {
      const files = Array.from(ev.target.files || []);
      if (uploadedImages.length + files.length > 5) {alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏£‡∏π‡∏õ'); return;}
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          uploadedImages.push({name: file.name, dataURL: e.target.result});
          displayUploadedImages();
        };
        reader.readAsDataURL(file);
      });
    }
    function displayUploadedImages() {
      const c = document.getElementById('uploadedImages');
      c.innerHTML = '';
      uploadedImages.forEach((img, idx) => {
        const src = img.dataURL || img.url;
        const wrap = document.createElement('div');
        wrap.className = 'relative';
        wrap.innerHTML = `
      <img src="${src}" class="w-16 h-16 rounded-lg object-cover border">
      <button class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-rose-500 text-white text-sm" onclick="removeImage(${idx})">‚úï</button>
    `;
        c.appendChild(wrap);
      });
    }
    function removeImage(i) {uploadedImages.splice(i, 1); displayUploadedImages();}

    // ===== Table & actions =====
    function displayRecords() {
      const tbody = document.getElementById('recordsTable');
      tbody.innerHTML = '';
      records.forEach((r, idx) => {
        const sevClass = r.severity === '‡∏™‡∏π‡∏á' ? 'text-rose-600 font-semibold'
          : r.severity === '‡∏Å‡∏•‡∏≤‡∏á' ? 'text-amber-600 font-semibold'
            : 'text-emerald-600 font-semibold';
        const imgSrc = r.images.length ? (r.images[0].dataURL || r.images[0].url) : null;
        const imgHTML = r.images.length
          ? `<img src="${imgSrc}" class="w-14 h-14 rounded object-cover inline-block align-middle"> ${r.images.length > 1 ? `(+${r.images.length - 1})` : ''}`
          : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-indigo-50';
        tr.innerHTML = `
      <td class="py-3 px-4">${r.date}</td>
      <td class="py-3 px-4">${r.studentId}</td>
      <td class="py-3 px-4">${r.studentName}</td>
      <td class="py-3 px-4">${r.className}</td>
      <td class="py-3 px-4">${r.incidentType}</td>
      <td class="py-3 px-4">${r.description}</td>
      <td class="py-3 px-4"><span class="${sevClass}">${r.severity}</span></td>
      <td class="py-3 px-4">${imgHTML}</td>
      <td class="py-3 px-4">${r.recorder}</td>
      <td class="py-3 px-4">
        <div class="flex gap-2">
          <button class="px-3 py-1 rounded bg-amber-500 hover:bg-amber-600 text-white" onclick="openModal(${idx})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="px-3 py-1 rounded bg-rose-500 hover:bg-rose-600 text-white" onclick="deleteRecord(${idx})">‡∏•‡∏ö</button>
        </div>
      </td>
    `;
        tbody.appendChild(tr);
      });
    }
    function deleteRecord(i) {
      if (confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        records.splice(i, 1);
        commitAndRender();
        if (isGoogleSheetsConnected) fetchFromGoogleSheets();
      }
    }
    function searchRecords() {
      const q = searchInput.value.toLowerCase();
      const rows = recordsTable.getElementsByTagName('tr');
      Array.from(rows).forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    }
    function updateStatistics() {
      totalIncidents.textContent = records.length;
      highSeverityCount.textContent = records.filter(r => r.severity === '‡∏™‡∏π‡∏á').length;
      mediumSeverityCount.textContent = records.filter(r => r.severity === '‡∏Å‡∏•‡∏≤‡∏á').length;
      lowSeverityCount.textContent = records.filter(r => r.severity === '‡∏ï‡πà‡∏≥').length;
    }

    // ===== Excel =====
    function exportToExcel() {
      const ws = XLSX.utils.json_to_sheet(records.map(r => ({
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': r.date, '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': r.studentId, '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': r.studentName, '‡∏ä‡∏±‡πâ‡∏ô': r.className,
        '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î': r.incidentType, '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': r.description, '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á': r.severity,
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û': r.images.length, '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å': r.recorder
      })));
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î');
      XLSX.writeFile(wb, `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
    function importFromExcel() {excelImport.click();}
    function handleExcelImport(e) {
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws);
        json.forEach(row => {
          records.push({
            date: row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || new Date().toISOString().split('T')[0],
            studentId: row['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '',
            studentName: row['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '',
            className: row['‡∏ä‡∏±‡πâ‡∏ô'] || '',
            incidentType: row['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î'] || '',
            description: row['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'] || '',
            severity: row['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á'] || '‡∏ï‡πà‡∏≥',
            images: [],
            recorder: row['‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'] || ''
          });
        });
        commitAndRender();
      };
      reader.readAsArrayBuffer(f);
    }

    // ===== Google Sheets (‡∏ú‡πà‡∏≤‡∏ô Apps Script Web App) =====
    async function connectGoogleSheets() {
      if (isGoogleSheetsConnected) {alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return;}
      try {
        gsBox.innerHTML = `<h3 class="text-xl font-semibold">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</h3><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>`;
        const resp = await fetch(WEB_APP_URL, {method: 'GET'});
        if (!resp.ok) throw new Error('Cannot reach Web App');
        isGoogleSheetsConnected = true;
        gsBox.innerHTML = `
      <h3 class="text-xl font-semibold">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h3>
      <p>üîó <a class="underline font-medium" href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î Google Sheets</a></p>
      <div class="mt-3 flex items-center justify-center gap-2">
        <button onclick="createSheetsHeaders()" class="px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-white">üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
        <button onclick="syncAllDataToGoogleSheets()" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white">üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>`;
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch (err) {
        console.error(err);
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Web App URL/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå');
      }
    }
    async function createSheetsHeaders() {
      if (!isGoogleSheetsConnected) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
      const body = 'payload=' + encodeURIComponent(JSON.stringify({action: 'createHeaders'}));
      const resp = await fetch(WEB_APP_URL, {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body});
      const data = await resp.json();
      if (!data.ok) return alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }
    async function syncToGoogleSheets(record, indexToUpdate = null) {
      if (!isGoogleSheetsConnected) return;

      const payload = {
        action: 'append',
        record: {
          date: record.date,
          studentId: record.studentId,
          studentName: record.studentName,
          className: record.className,
          incidentType: record.incidentType,
          description: record.description,
          severity: record.severity,
          images: record.images, // [{name,dataURL}] (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô Drive)
          imagesCount: record.images?.length || 0,
          recorder: record.recorder,
          loggedAt: new Date().toISOString().split('T')[0]
        }
      };
      const body = 'payload=' + encodeURIComponent(JSON.stringify(payload));
      const resp = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body
      });
      const data = await resp.json();
      if (!data.ok) {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö url ‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏ô records ‡πÄ‡∏õ‡πá‡∏ô url
      if (Array.isArray(data.images) && data.images.length) {
        const urls = data.images.map(it => ({url: it.viewUrl, name: it.name || ''}));
        if (indexToUpdate != null && records[indexToUpdate]) {
          records[indexToUpdate].images = urls;
        } else {
          // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏á push ‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
          const last = records.length - 1;
          if (last >= 0) records[last].images = urls;
        }
      }

      // ‡πÄ‡∏ã‡∏ü cache ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô url ‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏≠
      commitAndRender();
    }

    // async function syncToGoogleSheets(record) {
    //   if (!isGoogleSheetsConnected) return;
    //   const payload = {
    //     action: 'append',
    //     record: {
    //       date: record.date,
    //       studentId: record.studentId,
    //       studentName: record.studentName,
    //       className: record.className,
    //       incidentType: record.incidentType,
    //       description: record.description,
    //       severity: record.severity,
    //       images: record.images, // [{name,dataURL}] ‡∏´‡∏£‡∏∑‡∏≠ [{url}]
    //       imagesCount: record.images?.length || 0,
    //       recorder: record.recorder,
    //       loggedAt: new Date().toISOString().split('T')[0]
    //     }
    //   };
    //   const body = 'payload=' + encodeURIComponent(JSON.stringify(payload));
    //   const resp = await fetch(WEB_APP_URL, {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body});
    //   const data = await resp.json();
    //   if (!data.ok) alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    // }
    async function syncAllDataToGoogleSheets() {
      if (!isGoogleSheetsConnected) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
      if (records.length === 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á');
      const list = records.map(r => ({
        date: r.date, studentId: r.studentId, studentName: r.studentName, className: r.className,
        incidentType: r.incidentType, description: r.description, severity: r.severity,
        images: r.images, imagesCount: r.images?.length || 0, recorder: r.recorder,
        loggedAt: new Date().toISOString().split('T')[0]
      }));
      const body = 'payload=' + encodeURIComponent(JSON.stringify({action: 'appendBulk', records: list}));
      const resp = await fetch(WEB_APP_URL, {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body});
      const data = await resp.json();
      if (!data.ok) return alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      alert(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
      await fetchFromGoogleSheets(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    async function fetchFromGoogleSheets() {
      try {
        const resp = await fetch(WEB_APP_URL, {method: 'GET'});
        if (!resp.ok) throw new Error('fetch sheets failed');
        const data = await resp.json();
        if (!data.ok) throw new Error(data.message || 'sheets not ok');

        const list = (data.data || []).map(row => {
          const urls = (row['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'] || '')
            .toString()
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean)
            .map(u => ({url: u})); // ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Drive ‡πÑ‡∏î‡πâ

          return {
            date: row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || '',
            studentId: row['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '',
            studentName: row['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '',
            className: row['‡∏ä‡∏±‡πâ‡∏ô'] || '',
            incidentType: row['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏¥‡∏î'] || '',
            description: row['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'] || '',
            severity: row['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á'] || '‡∏ï‡πà‡∏≥',
            images: urls,
            recorder: row['‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'] || ''
          };
        });

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï ‡∏ó‡∏±‡∏ö records ‡πÅ‡∏•‡∏∞‡πÅ‡∏Ñ‡∏ä‡πÑ‡∏ß‡πâ
        if (list.length) {
          records = list;
          commitAndRender();
          isGoogleSheetsConnected = true;
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
          const box = document.getElementById('gsBox');
          if (box) {
            box.innerHTML = `
          <h3 class="text-xl font-semibold">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h3>
          <p>üîó <a class="underline font-medium" href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î Google Sheets</a></p>
          <div class="mt-3 flex items-center justify-center gap-2">
            <button onclick="createSheetsHeaders()" class="px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-white">üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
            <button onclick="syncAllDataToGoogleSheets()" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white">üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>`;
          }
        }
        return true;
      } catch (e) {
        console.warn('fetchFromGoogleSheets error', e);
        return false;
      }
    }

    // ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'n') {e.preventDefault(); openModal();}
      if (e.key === 'Escape') {closeModal();}
    });
  </script>

  <style>
    @media print {
      body * {
        visibility: hidden
      }

      table,
      table * {
        visibility: visible
      }

      table {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%
      }

      #printBtn,
      #recordModal,
      #gsBox,
      .grid,
      .flex {
        display: none !important
      }
    }
  </style>
</body>

</html>